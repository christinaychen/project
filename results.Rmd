
```{r}
# BYTXCQU
# F3SESQU
# F3SES
# els <- els %>%
#   mutate(F3ERN2011_ORIGINAL = F3ERN2011,
#          F3ERN2011 = ifelse(F3ERN2011 < 0, NA, F3ERN2011),
#          F3ERN2011 = log(F3ERN2011+0.1))

els <- els %>%
  mutate(TEST_COMP_QU = ifelse(BYTXCQU < 0, NA, BYTXCQU),
         TEST_COMP = ifelse(BYTXCSTD < 0, NA, BYTXCSTD)
         )


els <- els %>%
  mutate(SES_2011 = ifelse(F3SES < 0, NA, F3SES),
         SESQU_2011 = ifelse(F3SESQU < 0, NA, F3SESQU), SESQU_2011=factor(SESQU_2011, levels=c(1,2,3,4)))

els <- els %>%
  mutate(TEST_QU = ifelse(BYTXCQU < 0, NA, BYTXCQU), TEST_QU=factor(TEST_QU))

els <- els %>% mutate(
  ED_ATNMT = case_when(
    F3ATTAINMENT == 1 ~ "No GED",
    F3ATTAINMENT == 2 ~ "GED",
    F3ATTAINMENT ==3 | F3ATTAINMENT ==4 | F3ATTAINMENT ==5 ~ "Associates/\nSome Undergrad",
    F3ATTAINMENT ==6 ~ "Bachelors",
    F3ATTAINMENT ==7 | F3ATTAINMENT ==8~ "Master's/\nPost-Bacc. Cert.",
    F3ATTAINMENT ==10 ~ "PhD"
  )
)
els$ED_ATNMT = factor(els$ED_ATNMT, levels=c( "No GED", "GED", "Associates/\nSome Undergrad", "Bachelors", "Master's/\nPost-Bacc. Cert.", "PhD"))

# els %>%
#   filter(!is.na(ED_ATNMT)) %>%
#   ggplot() +
#     geom_bar(aes(x=ED_ATNMT)) +
#   theme(axis.text.x = element_text(angle = 45, vjust = 0.5, hjust=0.5)) +
#   labs(x="Education Attained", y="Count")
```

### Familial Predictors
- Race
- Socioeconomic status
- Family composition (see below)
- Parents' highest level of education
- Parents' English fluency
- How far in school parents wants student to go
- Has a computer at home
- Has Internet access
```{r}
# AI/AN = American Indian/Alaska Native
# API = Asian, Hawaii/Pacific Islander
els <- els %>% mutate(
  RACE = case_when(
    BYRACE == 1 | BYRACE ==6~ "AI/AN/Mixed",
    BYRACE ==2 ~ "API",
    BYRACE ==3 ~ "Black",
    BYRACE ==4 | BYRACE ==5 ~ "Hispanic",
    BYRACE ==7 ~ "White"
  )
)
els$RACE = factor(els$RACE, levels=c( "AI/AN/Mixed", "API", "Black", "Hispanic","White"))


# used base year data, if na, used f1 data
els <- els %>% mutate(
  BYFCOMP = na_if(BYFCOMP, BYFCOMP<0),
  FAM_COMP = case_when(
    BYFCOMP == 1 | BYFCOMP == 2 | BYFCOMP == 3 | BYFCOMP == 4 ~ "Two Parents",
    BYFCOMP ==5 | BYFCOMP == 6 | BYFCOMP ==7 | BYFCOMP == 8 | BYFCOMP == 9~ "Single/Absent Parent",
    F1FCOMP == 1 | F1FCOMP == 2 | F1FCOMP == 3 | F1FCOMP == 4~ "Two Parents",
    F1FCOMP ==5 | F1FCOMP == 6 | F1FCOMP ==7 | F1FCOMP == 8 | F1FCOMP == 9~ "Single/Absent Parent"
  )
)

els <- els %>% mutate(
  BYPARED = na_if(BYPARED, BYPARED<0),
  PT_ED = case_when(
    BYPARED == 1 | BYPARED == 2 ~ "Some HS/GED",
    BYPARED == 3 | BYPARED == 4| BYPARED == 5 ~ "Attend PS/Associate's",
    BYPARED == 6 ~ "Bachelors",
    BYPARED == 7 | BYPARED == 8 ~ "Advanced Degree"
  ),
  PT_ED_YEARS = case_when(
    BYPARED == 1 ~ 1,
    BYPARED == 2 ~ 4,
    BYPARED == 3 ~ 5,
    BYPARED == 4 ~ 6,
    BYPARED == 5 ~ 7,
    BYPARED == 6 ~ 8,
    BYPARED == 7 ~ 10,
    BYPARED == 8 ~ 12
  )
)
els$PT_ED = factor(els$PT_ED, levels=c("Some HS/GED", "Attend PS/Associate's","Bachelors", "Advanced Degree"))
els$PT_ED_YEARS = as.numeric(els$PT_ED_YEARS)


els <- els %>% mutate(
  SESQU = ifelse(BYSES1QU < 0, NA, BYSES1QU),
  SESQU = case_when(
    SESQU == 1 ~ "1st SES Quartile",
    SESQU == 2 ~ "2nd SES Quartile",
    SESQU == 3 ~ "3rd SES Quartile",
    SESQU == 4 ~ "4th SES Quartile"
  ),
  SESQU=factor(SESQU),
  SES = ifelse(BYSES1 <= -2, NA, BYSES1)
)

# els <- els %>% mutate(FAM_INCOME = factor(BYINCOME))

els <- els %>% mutate(
  PT_PUSH_1 = na_if(BYPARASP, BYPARASP<0),
  PT_PUSH = case_when(
    PT_PUSH_1 == 1 | PT_PUSH_1 ==2 ~ "Some HS/GED",
    PT_PUSH_1 == 3 | PT_PUSH_1 == 4 ~ "Attend PS/Associate's",
    PT_PUSH_1 == 5 ~ "Bachelor's",
    PT_PUSH_1 == 6 | PT_PUSH_1 == 7~ "Advanced Degree"
  ),
  PT_PUSH_YEARS = case_when(
    PT_PUSH_1 == 1 ~ 2,
    PT_PUSH_1 == 2 ~ 4,
    PT_PUSH_1 == 3 ~ 6,
    PT_PUSH_1 == 4 ~ 7,
    PT_PUSH_1 == 5 ~ 8,
    PT_PUSH_1 == 6 ~ 10,
    PT_PUSH_1 == 7 ~ 12
  )
)
els$PT_PUSH = factor(els$PT_PUSH, levels=c("Some HS/GED", "Any college (2 or 4 year)", "Bachelor's","Advanced Degree"))
els$PT_PUSH_YEARS = as.numeric(els$PT_PUSH_YEARS)


els <- els %>% mutate(
  COMP_HOME = ifelse(BYS84C < 0, NA, BYS84C),
  COMP_HOME=factor(COMP_HOME)
)

els <- els %>% mutate(
  HAS_INTERNET = ifelse(BYS84D < 0, NA, BYS84D),
  HAS_INTERNET=factor(HAS_INTERNET)
)

# els <- els %>% mutate(
#   PT_EXPT_SCSS = ifelse(BYS27I < 0, NA, BYS27I),
#   PT_EXPT_SCSS=case_when(
#     PT_EXPT_SCSS == 1 ~ "Strongly Agree",
#     PT_EXPT_SCSS == 2 ~ "Agree",
#     PT_EXPT_SCSS == 3 ~ "Disagree",
#     PT_EXPT_SCSS == 4 ~ "Strongly Disagree"
#   )
# )
```


### Educational Predictors
- School type (private/public/Catholic)
<!-- - School urbanicity (urban, suburban, rural) -->
<!-- - dropout prevention program offered -->
- Programs for pregnant girls/teenage mothers offered
<!-- - Vocational counseling/services/programs offered -->
<!-- - Learning hindrance score -->
<!--   - poor conditions: buildings (double weighted), heating/air/light (double weighted), science labs, fine arts facilities, lack of space (double weighted), library -->
<!--   - lack of supplies: texts (double weighted), computers, multi-media, poor tech equipment -->
<!-- - teacher access to technology -->
<!-- - highest salary paid to full-time teachers -->
- Percent of full-time teachers that are state certified
<!-- - % full-time teachers that teach out of field -->
- Percent of students with free lunch (see below)
- Has paid security at any time
<!-- - interaction between percent of students with free lunch and school type -->
- Percent of 10th graders in college prep program
- Learning is hindered by poor building conditions
- Learning is hindered by poor heating/air/light
- Learning is hindered by lack of space
- Learning is hindered by lack of supplies/texts

```{r}
els <- els %>% mutate(
  SCHOOL_TYPE=case_when(
    BYSCTRL == 1 ~ "Public",
    BYSCTRL == 2 ~ "Catholic",
    BYSCTRL == 3 ~ "Private"
  )
)

els <- els %>% mutate(
  SCHOOL_URBAN=case_when(
    BYURBAN == 1 ~ "Urban",
    BYURBAN == 2 ~ "Suburban",
    BYURBAN == 3 ~ "Rural"
  )
)

els <- els %>% mutate(
  DROPOUT_PREV_PGM = ifelse(F1A23 < 0, NA, F1A23),
  DROPOUT_PREV_PGM=factor(DROPOUT_PREV_PGM)
)

els <- els %>% mutate(
  PRG_PGM = ifelse(F1A21F < 0, NA, F1A21F),
  PRG_PGM=factor(PRG_PGM)
)

els <- els %>% mutate(
  VOCATIONAL_PGM = ifelse(F1A21A < 0, NA, F1A21A),
  VOCATIONAL_PGM=factor(VOCATIONAL_PGM)
)


els <- els %>% mutate(
  BYA50A_1 = ifelse(BYA50A<0, NA, BYA50A),
  BYA50B_1 = ifelse(BYA50B<0, NA, BYA50B),
  BYA50C_1 = ifelse(BYA50C<0, NA, BYA50C),
  BYA50D_1 = ifelse(BYA50D<0, NA, BYA50D),
  BYA50E_1 = ifelse(BYA50E<0, NA, BYA50E),
  BYA50F_1 = ifelse(BYA50F<0, NA, BYA50F),
  BYA50G_1 = ifelse(BYA50G<0, NA, BYA50G),
  BYA50H_1 = ifelse(BYA50H<0, NA, BYA50H),
  BYA50I_1 = ifelse( BYA50I<0,NA, BYA50I),
  BYA50J_1 = ifelse( BYA50J<0, NA, BYA50J),
  BYA50K_1 = ifelse(BYA50K<0, NA, BYA50K),
  LH_LACK_OF_SPACE = factor(case_when(
    BYA50E_1 <= 2 ~ "No",
    # BYA50E_1 <= 2 ~ "Some",
    BYA50E_1 <= 4 ~ "Yes"
  ), levels=c("No",  "Yes")),
  LH_POOR_BUILDINGS = factor(case_when(
    BYA50A_1 <= 2 ~ "No",
    # BYA50A_1 <= 2 ~ "Some",
    BYA50A_1 <= 4 ~ "Yes"
  ), levels=c("No",  "Yes")),
  LH_POOR_HEATING_AIR_LIGHT = factor(case_when(
    BYA50B_1 <= 2 ~ "No",
    # BYA50B_1 <= 2 ~ "Some",
    BYA50B_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  LH_LACK_TEXT = factor(case_when(
    BYA50G_1 <= 2 ~ "No",
    # BYA50G_1 <= 2 ~ "Some",
    BYA50G_1 <= 4 ~ "Yes"
  ), levels=c("No",  "Yes")),
  LH_LACK_COMPUTERS = factor(case_when(
    BYA50H_1 <= 2 ~ "No",
    # BYA50H_1 <= 2 ~ "Some",
    BYA50H_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  LH_LACK_TECH_FACILITIES = factor(case_when(
    BYA50K_1 <= 2 ~ "No",
    # BYA50K_1 <= 2 ~ "Some",
    BYA50K_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  LH_POOR_LIB = factor(case_when(
    BYA50F_1 <= 2 ~ "No",
    # BYA50F_1 <= 2 ~ "Some",
    BYA50F_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  LH_POOR_SCIENCE_LAB = factor(case_when(
    BYA50C_1 <= 2 ~ "No",
    # BYA50C_1 <= 2 ~ "Some",
    BYA50C_1 <= 4 ~ "Yes"
  ), levels=c("No","Yes")),
  LH_POOR_ARTS_FACILITIES = factor(case_when(
    BYA50D_1 <= 2 ~ "No",
    # BYA50D_1 <= 2 ~ "Some",
    BYA50D_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  LH_POOR_MULTIMEDIA = factor(case_when(
    BYA50I_1 <= 2 ~ "No",
    # BYA50D_1 <= 2 ~ "Some",
    BYA50I_1 <= 4 ~ "Yes"
  ), levels=c("No", "Yes")),
  # LH_POOR_CONDITIONS = (LH_POOR_BUILDINGS=="Yes") + (LH_POOR_HEATING_AIR_LIGHT=="Yes") + (LH_LACK_OF_SPACE == "Yes"),
  # LH_POOR_FACILITIES = LH_POOR_ARTS_FACILITIES=="Yes" + LH_POOR_SCIENCE_LAB=="Yes" + LH_POOR_LIB == "Yes",
  # LH_POOR_TECH = LH_LACK_TECH_FACILITIES == "Yes" + LH_POOR_MULTIMEDIA == "Yes" + LH_LACK_COMPUTERS == "Yes",
  
  LEARNING_HINDERED_POOR_CONDITIONS_SCORE = BYA50A_1 + BYA50B_1 + BYA50E_1,
  LEARNING_HINDERED_LACK_SUPPLIES_SCORE = BYA50G_1,
  LEARNING_HINDERED_POOR_TECH_SCORE = BYA50D_1 + BYA50I_1 + BYA50H_1,
  # LEARNING_HINDERED_LACK_SPACE_SCORE = BYA50E_1,
  LEARNING_HINDERED_POOR_FACILITIES_SCORE = BYA50D_1+BYA50C_1+BYA50F_1
  # LEARNING_HINDERED = LEARNING_HINDERED_CONDITIONS + LEARNING_HINDERED_LACK_SUPPLIES,
  # LEARNING_HINDERED_QU = case_when(
  #   LEARNING_HINDERED <=4 ~ 1,
  #   LEARNING_HINDERED <6 ~ 2,
  #   LEARNING_HINDERED <=8 ~ 3,
  #   LEARNING_HINDERED <=15 ~ 4
  # ),
  # LEARNING_HINDERED_QU = factor(LEARNING_HINDERED_QU),
  # LEARNING_HINDERED_CONDITIONS_QU = case_when(
  #   LEARNING_HINDERED_CONDITIONS <=3 ~ 1,
  #   LEARNING_HINDERED_CONDITIONS <=4 ~ 2,
  #   LEARNING_HINDERED_CONDITIONS <=6 ~ 3,
  #   LEARNING_HINDERED_CONDITIONS <=12 ~ 4
  # ),
  # LEARNING_HINDERED_CONDITIONS_QU = factor(LEARNING_HINDERED_CONDITIONS_QU),
  # LEARNING_HINDERED_LACK_SUPPLIES_QU = case_when(
  #   LEARNING_HINDERED_LACK_SUPPLIES <=4 ~ 1,
  #   LEARNING_HINDERED_LACK_SUPPLIES <=6 ~ 2,
  #   LEARNING_HINDERED_LACK_SUPPLIES <=8 ~ 3,
  #   LEARNING_HINDERED_LACK_SUPPLIES <=16 ~ 4
  # ),
  # LEARNING_HINDERED_LACK_SUPPLIES_QU = factor(LEARNING_HINDERED_LACK_SUPPLIES_QU)
)

els <- els %>% mutate(
  FREE_LUNCH_PERC = factor(ifelse(F1SCFLP < 0, NA, F1SCFLP)),
  FREE_LUNCH_PERC_10 = factor(ifelse(BY10FLP < 0, NA, BY10FLP))

)


els <- els %>% mutate(
  SECURITY = factor(ifelse(BYA40A < 0, NA, BYA40A)),
  FREE_LUNCH_CATEGORIES = case_when(
    as.numeric(FREE_LUNCH_PERC) == 1 ~ "<=5%",
    as.numeric(FREE_LUNCH_PERC) <= 4 ~ "<=30%",
    as.numeric(FREE_LUNCH_PERC) <= 5 ~ "<=50%",
    as.numeric(FREE_LUNCH_PERC) <= 6 ~ "<=75%",
    as.numeric(FREE_LUNCH_PERC) <= 7 ~ ">75%",
    
    as.numeric(FREE_LUNCH_PERC_10) == 1 ~ "<=5%",
    as.numeric(FREE_LUNCH_PERC) <= 4 ~ "<=30%",
    as.numeric(FREE_LUNCH_PERC_10) <= 5 ~ "<=50%",
    as.numeric(FREE_LUNCH_PERC_10) <= 6 ~ "<=75%",
    as.numeric(FREE_LUNCH_PERC_10) <= 7 ~ ">75%"
    
  )

)

# els <- els %>% mutate(
#   FREE_LUNCH_CATEGORIES = case_when(
#     as.numeric(FREE_LUNCH_PERC) <= 1 ~ "<=5%",
#     as.numeric(FREE_LUNCH_PERC) <= 4 ~ "<=30%",
#     as.numeric(FREE_LUNCH_PERC) <= 5 ~ "<=50%",
#     # as.numeric(FREE_LUNCH_PERC) <= 6 ~ "<=75%",
#     as.numeric(FREE_LUNCH_PERC) <= 7 ~ ">50%"
#   )
# 
# )

# els$FREE_LUNCH_CATEGORIES = factor(els$FREE_LUNCH_CATEGORIES, levels = c("<=5%",  "<=30%", "<=50%", ">50%"))
els$FREE_LUNCH_CATEGORIES = factor(els$FREE_LUNCH_CATEGORIES, levels = c("<=5%", "<=30%", "<=50%", "<=75%", ">75%"))

# assume negative value is 0
els <- els %>% mutate(
  BYA41A_1 = ifelse( BYA41A<0, 0, BYA41A),
  BYA41B_1 = ifelse( BYA41B<0, 0, BYA41B),
  BYA41C_1 = ifelse( BYA41C<0, 0, BYA41C),
  BYA41D_1 = ifelse( BYA41D<0, 0, BYA41D),
  BYA41E_1 = ifelse( BYA41E<0, 0, BYA41E),
  BYA41F_1 = ifelse( BYA41F<0, 0, BYA41F),
  BYA41G_1 = ifelse( BYA41G<0, 0, BYA41G),
  BYA41H_1 = ifelse( BYA41H<0, 0, BYA41H),
  BYA41I_1 = ifelse( BYA41I<0, 0, BYA41I),
  BYA41J_1 = ifelse( BYA41J<0, 0, BYA41J),
  BYA41K_1 = ifelse( BYA41K<0, 0, BYA41K),
  BYA41L_1 = ifelse( BYA41L<0, 0, BYA41L),
  BYA41M_1 = ifelse(BYA41M<0, 0, BYA41M),
  TEACHER_BASIC_TECH_ACCESS = factor(BYA41K_1 & BYA41L_1 & BYA41M_1),
  TEACHER_TECH_ACCESS = BYA41A_1+ BYA41B_1+BYA41C_1+BYA41D_1+BYA41E_1+BYA41F_1+BYA41G_1+BYA41H_1+BYA41I_1+BYA41J_1+2*BYA41K_1+2*BYA41L_1+ BYA41M_1
)

els <- els %>% mutate(
  BYA43A = ifelse(BYA43A < 0, NA, BYA43A),
  BYA43B = ifelse(BYA43B < 0, NA, BYA43B),
  BYA43C = ifelse(BYA43C < 0, NA, BYA43C),
  BYA43D = ifelse(BYA43D < 0, NA, BYA43D),
  BYA43E = ifelse(BYA43E < 0, NA, BYA43E),

  TEACHER_TRAINING_TECH= BYA43A+BYA43B+BYA43C+BYA43D+BYA43E
)


els <- els %>% mutate(
  GOOD_TEACHERS_HIGHER_PAY = ifelse(BYA28F < 0, NA, BYA28F),
  GOOD_TEACHERS_HIGHER_PAY= factor(GOOD_TEACHERS_HIGHER_PAY)
)

els <- els %>% mutate(
  TUTORING = ifelse(F1A17D < 0, NA, F1A17D),
  TUTORING = case_when(
    TUTORING == 1 ~ 0,
    TUTORING == 2 | TUTORING==3 ~ 1
  ),
  TUTORING= factor(TUTORING)
)

els <- els %>% mutate(
  LIBRARY_COMPUTER_LAB = ifelse(BYL03F < 0, NA, BYL03F),
  LIBRARY_COMPUTER_LAB= factor(LIBRARY_COMPUTER_LAB)
)

els <- els %>% mutate(
  HIGHEST_TEACHER_SALARY = ifelse(BYA26B < 0, NA, BYA26B),
  LOWEST_TEACHER_SALARY = ifelse(BYA26A < 0, NA, BYA26A),
  TEACHER_SALARY_DISPARITY = HIGHEST_TEACHER_SALARY - LOWEST_TEACHER_SALARY,
  LOWEST_TEACHER_SALARY_THOUSANDS = LOWEST_TEACHER_SALARY/1000
)
els$PERC_SOPH_COLLEGE_PREP = els$BYA14B
```


```{r}
els <- els %>%
  mutate(
   DROPPED_OUT = case_when(
     F3EVERDO == 1 ~ TRUE,
     F3EVERDO == 0 ~ FALSE
   )
)
els <- els %>%
  mutate(ED_ATNMT_BACHELORS = !(ED_ATNMT == 'No GED' | ED_ATNMT == 'GED' | ED_ATNMT == 'Associates/\nSome Undergrad')
)

els <- els %>%
  mutate(
    SCHOOL_TYPE1 = SCHOOL_TYPE,
    SCHOOL_TYPE = case_when(
      SCHOOL_TYPE == "Private" | SCHOOL_TYPE =="Catholic" ~ "Private/Catholic",
      SCHOOL_TYPE == "Public" ~ "Public"
    )
  )

els <- els %>%
  mutate(FREE_LUNCH_MAJ = 
    !(FREE_LUNCH_CATEGORIES == "<=30%" |  FREE_LUNCH_CATEGORIES == "<=5%" | FREE_LUNCH_CATEGORIES == "<=50%")
  )

els_new <- els[,c("SCHOOL_TYPE", "RACE", "FAM_COMP", "SES", "PT_ED", "PT_PUSH", "COMP_HOME", "HAS_INTERNET", "TEACHER_TECH_ACCESS",  "PERC_SOPH_COLLEGE_PREP", "LOWEST_TEACHER_SALARY_THOUSANDS", "TEST_COMP", "SESQU_2011", "DROPPED_OUT", "ED_ATNMT_BACHELORS", "PT_ED_YEARS", "PT_PUSH_YEARS", "SES_2011", 
                  "BYA50A_1",
  "BYA50B_1",
  "BYA50C_1",
  "BYA50D_1",
  "BYA50E_1",
  "BYA50F_1",
  "BYA50G_1",
  "BYA50H_1",
  "BYA50K_1", "FREE_LUNCH_CATEGORIES", "FREE_LUNCH_MAJ"
  #                 "LEARNING_HINDERED_POOR_CONDITIONS_SCORE" ,
  # "LEARNING_HINDERED_LACK_SUPPLIES_SCORE",
  # "LEARNING_HINDERED_POOR_TECH_SCORE",
  # "LEARNING_HINDERED_LACK_SPACE_SCORE",
  # "LEARNING_HINDERED_POOR_FACILITIES_SCORE"
  )]

# https://stats.idre.ucla.edu/r/faq/how-do-i-perform-multiple-imputation-using-predictive-mean-matching-in-r/
# els_imputed <- mice(els_new, m=1, maxit = 50, seed = 500, method="pmm")

```

```{r}

els_complete <- complete(els_imputed, 1)
```

# Methodology

Due to the number of variables used in the models, there are many observations that have missing data in at least one of the variables. Therefore, we use the `mice` package to impute the data using the predictive mean-matching method.

## Standardized Test Composite Score

Our first measure of student success is standardized test composite score, which combines the math and reading scores. In order to compare the correlations between family and school predictors and the test composite, we are using a model that includes predictors from both groups. This way, the effect sizes of variables of interest are adjusted for by the inclusion of more potential confounding variables. Since test composite is a continuous variable, we decided to an ordinary least squares model specified below:


\begin{align*}
\text{test composite}_i = &\beta_0 + \beta_11(\text{school type=private}) + \beta_21(\text{school type=public}) +

&\beta_3 1(\text{race=Mixed}) + \beta_4 1(\text{race=API}) + \beta_5 1(\text{race=Black}) + 
\beta_{6} 1(\text{race=Hispanic}) + \beta_{7} 1(\text{race=White}) +
\beta_{8} 1(\text{family composition=two parents}) +  \beta_{9} \text{SES} \\+
&\beta_{10}(\text{parents' # years ed.}) + \beta_{13}(\text{# years ed. parents desire for student}) + \beta_{16}1(\text{has computer at home}) + \beta_{14}1(\text{has internet at home}) \\
+ &\beta_{15}(\text{teachers' tech access score}) + \beta_{16}1(\text{library has computer lab})
+\beta_{17}(\text{% sophomores in college prep program}) + \beta_{18}(\text{lowest teacher salary (thousands)}) \\
+ & \beta_{19}(\text{learning hindered by poor buildings}) + \beta_{20}(\text{learning hindered by poor heating/air/light}) + \beta_{21}1(\text{learning hindered by poor science labs}) \\+& \beta_{22}1(\text{learning hindered by poor fine arts facilities})+ \beta_{23}1(\text{learning hindered by lack of space})+ \beta_{24}1(\text{learning hindered by poor library})  \\
+& \beta_{25}1(\text{learning hindered by lack of text/supplies}) + \beta_{26}1(\text{learning hindered by too few computers}) \\
+& \beta_{27}1(\text{learning hindered by lack of tech equipment})+ \beta_{28}1(\text{free lunch percentage} > 50%) + \epsilon_i, \ 
\text{where } \epsilon_i \stackrel{i.i.d.}{\sim} \mathcal{N}(0, \sigma^2)
\end{align*}


OLS models have model assumptions of independence, normality, homoscedasticity (constant variance), and linearity between predictors and the response. Since each of the observations in our data comes from a single student, the independence assumption is satisfied. To assess the other assumptions and multicollinearity, model diagnostics are analyzed in the Appendix.

```{r}
# test_model_family = lm(BYTXCSTD ~ RACE + FAM_COMP + SES + PT_ED + PT_PUSH + COMP_HOME + HAS_INTERNET, data = els_complete)
# summary(test_model_family)
# 
# plot(test_model_family)
# 
# 
# # els$bad_conditions = els$LACK_OF_SPACE=="Yes" | els$POOR_BUILDINGS=="Yes" | els$POOR_HEATING_AIR_LIGHT =="Yes"
# test_model_school = lm(BYTXCSTD ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM + TEACHER_TECH_ACCESS*FREE_LUNCH_CATEGORIES+TEACHER_TRAINING_TECH  + PERC_SOPH_COLLEGE_PREP+LOWEST_TEACHER_SALARY_THOUSANDS+LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES, data = els, na.action=na.omit)
# summary(test_model_school)
# 
# car::vif(test_model_school)
# plot(test_model_school)

# els <- els %>%
#   mutate(
#     PT_ED_YEARS_SQ = PT_ED_YEARS^2,
#     PT_PUSH_YEARS_SQ = PT_PUSH_YEARS^2
#   )

# els <- els %>%
#   mutate(
#     PT_BACHELORS = PT_ED_YEARS >=8,
#     PT_PUSH_BACHELORS = PT_PUSH_YEARS >= 8
#   )

# test_model_both = lm(TEST_COMP ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_POOR_LIB + FREE_LUNCH_CATEGORIES, data = els_complete)
# summary(test_model_both)
# els_complete$LEARNING_HINDERED_POOR_CONDITIONS_SCORE1 = els_complete$LEARNING_HINDERED_POOR_CONDITIONS_SCORE - els_complete$LEARNING_HINDERED_LACK_SPACE_SCORE



test_model_both = lm(TEST_COMP ~ SCHOOL_TYPE  + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +BYA50A_1+
  BYA50B_1+
  BYA50C_1+
  BYA50D_1+
  BYA50E_1*FREE_LUNCH_MAJ+
  BYA50F_1+
  BYA50G_1+
  BYA50H_1+
  BYA50K_1, data = els_complete)
summary(test_model_both)
# View(els[15110,c("SCHOOL_TYPE", "SCHOOL_URBAN","DROPOUT_PREV_PGM","VOCATIONAL_PGM","POOR_BUILDINGS","POOR_HEATING_AIR_LIGHT","LACK_TEXT","FREE_LUNCH_CATEGORIES","LACK_OF_SPACE","SECURITY", "RACE","FAM_COMP","SES","PT_ED", "PT_PUSH","COMP_HOME","HAS_INTERNET")])


# SENSITIVITY ANALYSSI
test_model_both = lm(TEST_COMP ~ SCHOOL_TYPE  + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +BYA50A_1*FREE_LUNCH_MAJ+
  BYA50B_1+
  BYA50C_1+
  BYA50D_1+
  BYA50E_1+
  BYA50F_1+
  BYA50G_1+
  BYA50H_1+
  BYA50K_1, data = els_complete)
summary(test_model_both)
```


## Socioeconomic Status

Another measure of student success is socioeconomic standing after leaving school. We analyze the student's SES quantile 9 years after the base year of when the student is in 10th grade. We performed sensitivity analysis with linear regression of the SES measure itself, but the model performed poorly. In addition, it is easier to interpret the outcome as quantiles, since the data source does not make it clear how the SES quantifications are calculated. Therefore, since the outcome is an ordinal categorical variable, we use ordinal logistic regression as follows:

$$
\begin{align*}
logit(P(\text{SES quantile} \leq i)) = &\beta_0 + \beta_11(\text{school type=private}) + \beta_21(\text{school type=public}) +
+
&\beta_3 1(\text{race=Mixed}) + \beta_4 1(\text{race=API}) + \beta_5 1(\text{race=Black}) + 
\beta_{6} 1(\text{race=Hispanic}) + \beta_{7} 1(\text{race=White}) +
\beta_{8} 1(\text{family composition=two parents}) +  \beta_{9} \text{SES} \\+
&\beta_{10}(\text{parents' # years ed.}) + \beta_{13}(\text{# years ed. parents desire for student}) + \beta_{16}1(\text{has computer at home}) + \beta_{14}1(\text{has internet at home}) \\
+ &\beta_{15}(\text{teachers' tech access score}) + \beta_{16}1(\text{library has computer lab})
+\beta_{17}(\text{% sophomores in college prep program}) + \beta_{18}(\text{lowest teacher salary (thousands)}) \\
+ & \beta_{19}(\text{learning hindered by poor buildings}) + \beta_{20}(\text{learning hindered by poor heating/air/light}) + \beta_{21}1(\text{learning hindered by poor science labs}) \\+& \beta_{22}1(\text{learning hindered by poor fine arts facilities})+ \beta_{23}1(\text{learning hindered by lack of space})+ \beta_{24}1(\text{learning hindered by poor library})  \\
+& \beta_{25}1(\text{learning hindered by lack of text/supplies}) + \beta_{26}1(\text{learning hindered by too few computers}) \\
+& \beta_{27}1(\text{learning hindered by lack of tech equipment})+\\

+& \beta_{31}1(\text{free lunch percentage}\leq 30%)+ \beta_{32}1(\text{free lunch percentage} \leq 50%)+ \beta_{33}1(\text{free lunch percentage}\leq 75%)+ \beta_{34}1(\text{free lunch percentage} > 75%)\\
\forall i\in{1,2,3,4}
\end{align*}
$$
<!-- https://bookdown.org/mpfoley1973/data-sci/ordinal-logistic-regression.html -->

Ordinal regression has four assumptions: response variable is ordinal, explanatory variables are continuous or categorical, no multicollinearity, and that odds are proportional. The response variable is ordinal because of the nature of quantiles. All explanatory variables used are continuous or categorical. The variables that have an ordinal nature are accounted for by making them numerical or treating them as categorical variables. Multicollinearity is tested for using VIF, and a full likelihood ratio test is used to test for proportionality (see Appendix).

```{r}
# https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
# ses_model_family = polr(SESQU_2011 ~ RACE + FAM_COMP + SES + PT_ED + PT_PUSH + COMP_HOME + HAS_INTERNET, data = els, Hess = TRUE)
# ses_model_family_summary = summary(ses_model_family)
# (ctable <- coef(ses_model_family_summary))
# p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
# (ctable <- cbind(ctable, "p value" = p))

# https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
ses_model = polr(SESQU_2011 ~ SCHOOL_TYPE + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS  + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +BYA50A_1+
  BYA50B_1+
  BYA50C_1+
  BYA50D_1+
  BYA50E_1*FREE_LUNCH_MAJ+
  BYA50F_1+
  BYA50G_1+
  BYA50H_1+
  BYA50K_1, data = els, Hess = TRUE)
ses_model_summary = summary(ses_model)
ctable <- coef(ses_model_summary)
p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
is_sig <- p <= 0.05
(ctable <- cbind(ctable, "p value" = p, "sig"=is_sig))


# test_model_both = lm(TEST_COMP ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED + PT_PUSH + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES + FREE_LUNCH_CATEGORIES, data = els_complete)
# summary(test_model_both)
# plot(test_model_both)

# sensitivy analysis with including test composite

```







```{r}
# ses_model_lm = lm(log(SES_2011+0.1) ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS + PT_PUSH_YEARS + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP*FREE_LUNCH_CATEGORIES + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES , data = els)
# 
# summary(ses_model_lm)
# plot(ses_model_lm)

```


## Education Attainment

Our third measure of success is the level of education the student attained. Since there are 6 levels that we coded from the data and our variables include lots of categorical variables, there is a high possibility of a small sample size for many of the groupings of levels between the predictors and outcome. Therefore, we analyze models for outcomes of whether a student graduated high school and whether a student graduated college using logistic regression models, defined below:

$$
\begin{align*}
logit( P(\text{Dropped Out HS}_i = Yes) = &\beta_0 + \beta_11(\text{school type=private}) + \beta_21(\text{school type=public}) +
+
&\beta_3 1(\text{race=Mixed}) + \beta_4 1(\text{race=API}) + \beta_5 1(\text{race=Black}) + 
\beta_{6} 1(\text{race=Hispanic}) + \beta_{7} 1(\text{race=White}) +
\beta_{8} 1(\text{family composition=two parents}) +  \beta_{9} \text{SES} \\+
&\beta_{10}(\text{parents' # years ed.}) + \beta_{13}(\text{# years ed. parents desire for student}) + \beta_{16}1(\text{has computer at home}) + \beta_{14}1(\text{has internet at home}) \\
+ &\beta_{15}(\text{teachers' tech access score})
+\beta_{17}(\text{% sophomores in college prep program}) + \beta_{18}(\text{lowest teacher salary (thousands)}) \\
+ & \beta_{19}(\text{learning hindered by poor buildings}) + \beta_{20}(\text{learning hindered by poor heating/air/light}) + \beta_{21}1(\text{learning hindered by poor science labs}) \\+& \beta_{22}1(\text{learning hindered by poor fine arts facilities})+ \beta_{23}1(\text{learning hindered by lack of space})+ \beta_{24}1(\text{learning hindered by poor library})  \\
+& \beta_{25}1(\text{learning hindered by lack of text/supplies}) + \beta_{26}1(\text{learning hindered by too few computers}) \\
+& \beta_{27}1(\text{learning hindered by lack of tech equipment})+\\

+& \beta_{31}1(\text{free lunch percentage}> 50%)\\

\end{align*}

\begin{align*}

logit( P(\text{Received Bachelor's}_i = Yes) = &\beta_0 + \beta_11(\text{school type=private}) + \beta_21(\text{school type=public}) +
+
&\beta_3 1(\text{race=Mixed}) + \beta_4 1(\text{race=API}) + \beta_5 1(\text{race=Black}) + 
\beta_{6} 1(\text{race=Hispanic}) + \beta_{7} 1(\text{race=White}) +
\beta_{8} 1(\text{family composition=two parents}) +  \beta_{9} \text{SES} \\+
&\beta_{10}(\text{parents' # years ed.}) + \beta_{13}(\text{# years ed. parents desire for student}) + \beta_{16}1(\text{has computer at home}) + \beta_{14}1(\text{has internet at home}) \\
+ &\beta_{15}(\text{teachers' tech access score}) + \beta_{16}1(\text{library has computer lab})
+\beta_{17}(\text{% sophomores in college prep program}) + \beta_{18}(\text{lowest teacher salary (thousands)}) \\
+ & \beta_{19}(\text{learning hindered by poor buildings}) + \beta_{20}(\text{learning hindered by poor heating/air/light}) + \beta_{21}1(\text{learning hindered by poor science labs}) \\+& \beta_{22}1(\text{learning hindered by poor fine arts facilities})+ \beta_{23}1(\text{learning hindered by lack of space})+ \beta_{24}1(\text{learning hindered by poor library})  \\
+& \beta_{25}1(\text{learning hindered by lack of text/supplies}) + \beta_{26}1(\text{learning hindered by too few computers}) \\
+& \beta_{27}1(\text{learning hindered by lack of tech equipment})+\\

+& \beta_{31}1(\text{free lunch percentage}> 50%)\\
\end{align*}

$$

The assumptions for logistic regression are independence, no multicollinearity, and a large sample size. All observations are independent, as they are sampled from individual students. Multicollinearity is tested for using VIF (see Appendix). Finally, since there are many categorical variables used in our model, there are many combinations of levels. Although categorical variable levels were combined to reduce the total number of samples needed, there are still a few levels that have only a couple of samples. Therefore, this assumption is not fully met due to imbalanced data. However, since we are only performing inference, this may not need to be addressed further, as we will not be analyzing the less frequent combinations of variables.

```{r}
# els_complete <- els_complete %>%
#   mutate(ED_ATNMT_CONDENSED = case_when(
#     ED_ATNMT == 'No GED' ~ 1,
#     ED_ATNMT == 'GED' | ED_ATNMT == 'Associates/\nSome Undergrad' ~ 2,
#     TRUE ~ 3
#   ))
# 
# els_complete$ED_ATNMT_CONDENSED = factor(els_complete$ED_ATNMT_CONDENSED, levels=c(1,2,3))



ed_model <- glm(DROPPED_OUT ~SCHOOL_TYPE  + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS  + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +BYA50A_1+
  BYA50B_1+
  BYA50C_1+
  BYA50D_1+
  BYA50E_1*FREE_LUNCH_MAJ+
  BYA50F_1+
  BYA50G_1+
  BYA50H_1+
  BYA50K_1 + FREE_LUNCH_MAJ, data=els_complete, family="binomial")
summary(ed_model)

```






<!-- ### Bachelor's Attained -->
```{r}
# els_complete <- els_complete %>%
#   mutate(ED_ATNMT_YEARS = case_when(
#     ED_ATNMT == 'No GED' ~ 2,
#     ED_ATNMT == 'GED' ~ 4,
#     ED_ATNMT == 'Associates/\nSome Undergrad' ~ 6,
#     ED_ATNMT == 'Bachelors' ~ 8,
#     ED_ATNMT == "Master's/\nPost-Bacc. Cert." ~ 10,
#     ED_ATNMT == "PhD" ~ 12
#   ))

# ed_model_lm = lm(ED_ATNMT_YEARS ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS + PT_PUSH_YEARS + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP*FREE_LUNCH_CATEGORIES + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES  + TEST_COMP, data = els_complete)
# summary(ed_model_lm)
# plot(ed_model_lm)



ed_model_bachelors <- glm(ED_ATNMT_BACHELORS ~ SCHOOL_TYPE  + RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +BYA50A_1+
  BYA50B_1+
  BYA50C_1+
  BYA50D_1+
  BYA50E_1*FREE_LUNCH_MAJ+
  BYA50F_1+
  BYA50G_1+
  BYA50H_1+
  BYA50K_1 + FREE_LUNCH_MAJ, data=els_complete, family = "binomial")

summary(ed_model_bachelors)

# ed_model = polr(ED_ATNMT ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS + PT_PUSH_YEARS + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE*FREE_LUNCH_CATEGORIES+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES  + TEST_COMP, data = els, Hess = TRUE)
# ed_model_summary = summary(ed_model)
# ctable <- coef(ed_model_summary)
# p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
# is_sig <- p <= 0.05
# (ctable <- cbind(ctable, "p value" = p, "sig"=is_sig))
# # ~ 10000 OBS WITH MISSING DATA
# 
# car::vif(ed_model)
```


# Appendix


## Standardized Test Composite Score

```{r}
plot(test_model_both)
car::vif(test_model_both)
```


## SES Status
```{r}
# proportional odds test
mlm <- nnet::multinom(SESQU_2011 ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS + PT_PUSH_YEARS + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP*FREE_LUNCH_CATEGORIES + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB  + TEST_COMP, data = els_complete)
G <- -2 * (logLik(ses_model)[1] - logLik(mlm)[1])
pchisq(G, df = length(ses_model$zeta) - 1, lower.tail = FALSE)

car::vif(ses_model)
```


## Education Attainment
