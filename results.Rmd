---
# title: "Results"
# author: "Christina Chen"
output: pdf_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = FALSE)
library(dplyr)
library(ggplot2)
library(MASS)
library(lme4)
library(mice)
library(kableExtra)
library(gridExtra)
library(grid)
library(tidyr)
library(tidyverse)
library(knitr)
library(MASS)
library(broom)
library(rms)
library(kableExtra)
library(patchwork)
library(car)

els_complete <- read.csv("els_imputed.csv")
els <- read.csv("els_filtered.csv")
```


# Results



## Standardized Test Composite Score

```{r}
test_model_both = lm(TEST_COMP ~  RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS+ PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete)
test_model_summary = summary(test_model_both)

get_results_table <- function(mod_summary, var_names_formatted, caption) {
  coef <- (formatC(round(mod_summary$coefficients[,1], 3), format='f', digits=3))
  std_error <- round(mod_summary$coefficients[,2], 3)
  p_val <- formatC(round(mod_summary$coefficients[,4], 3), format='f', digits=3)
  p_val_formatted <- c()
  for(i in 1:length(p_val)) {
    if (p_val[i] < 0.001) {
      p_val_formatted = c(p_val_formatted, "<0.001")
    } else {
      p_val_formatted = c(p_val_formatted, as.character(p_val[i]))
    }
  }
  table <- cbind(coef,std_error)
  table <- cbind(table, p_val_formatted)
  colnames(table) = c("Coef","Std. Error", "P-value")
  rownames(table) = var_names_formatted
  # tb <- knitr::kable(table, booktabs=T)
  #https://community.rstudio.com/t/aligning-tables-in-the-center/6699/2
  sig = which(p_val<0.05)
  ret <- table %>%
    kable(booktabs = T, caption=caption) %>%
    kable_styling(latex_options = "hold_position", full_width = F) %>%
    # row_spec(c(2:10), bold = F, color = "black", background = "#E3C5C5") %>%
    # row_spec(c(11:21), bold = F, color = "black", background = "#C5D0E3") %>%
    row_spec(sig[ifelse(sig<=10 & sig>=2, TRUE,FALSE)], background = "#E3C5C5") %>%
    row_spec(sig[ifelse(sig<=23 & sig>=11, TRUE,FALSE)], background = "#C5D0E3")
  return(ret)
}


get_results_table(test_model_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes", "% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: OLS Model for Test Composite Score")

```

The student's family's socioeconomic status has a positive relationship with test composite score: controlling for other variables, when SES increases by one unit, the student's test composite score increases by 2 points. On the other hand, we can look at variables that serve as proxies of the finances of the school. The type of school a student attends is not significantly associated with the student's test composite score. However, whether or not a student went to a school where the majority of students received free lunch is significantly correlated with test composite score. If a student went to a school where the majority of students received free lunch, test scores decreased by 1.04 on average, with all else held constant. Therefore, in terms of financial factors, it seems that finances of the student's home has a higher magnitude of correlation with test composite.

External motivational factors from both home and school are significantly associated with test composite. For each additional year that the student's parent(s) push him/her to go in school, his/her test composite score increases by 0.461 points, all else held constant. On the other hand, it seems that with each extra year the student's math or English teacher pushes him/her to achieve in school, his/her test composite increases by more than a point, while adjusting for other factors. In addition, the percentage of sophomores in a college prep program at the time of the base year survey is also significantly correlated with student test composite score. However, with every one percent increase of sophomores who were in a college prep program at school, the average test score increases by only 0.006, adjusting for other variables. Taking all of these factors into account, the student's school environment through external motivation seems to be more strongly correlated with the outcome.

Comparing home and school factors, the student's access to technology at home is significant, while learning hindrance due to lack of technology at school is not. In terms of the student's access to technology at home, students who have a computer and internet at home score, on average, 0.9 points higher on the standardized test than students who do not have access to either at home, with all other variables controlled. In addition, race is a significant predictor as well, with indicators of the student being Black or Hispanic negatively associated with the test composite score. Test composite score is negatively associated with learning hindrances at school, namely by poor facilities (arts, science labs, libraries) and by poor building conditions. However, the outcome is actually positively correlated with learning hindrances due to poor heating/air/light. This could be a source of future investigation, since it may be affected by other confounding variables. Due to the effect sizes of a student's technology access at home and their race, we conclude that home conditions are more strongly correlated with test composite.

Taking into account all of the variables that are significantly associated with test composite, it seems that the home factors are more strongly correlated with test composite in terms of environmental conditions and finances. However, influence from adults seem to be more strongly correlated with the outcome at school than at home.

## Socioeconomic Status Quantile

```{r}
# https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
ses_model = polr(factor(SESQU_2011) ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete, Hess = TRUE)
ses_model_summary = summary(ses_model)
# ctable <- coef(ses_model_summary)
# p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
# is_sig <- p <= 0.05
# (ctable <- cbind(ctable, "exp(coef)" = exp(ctable[,"Value"]), "p value" = p, "sig"=is_sig))

get_results_table_ordinal <- function(mod_summary, var_names_formatted, cap) {
  coef <- (formatC(round(mod_summary$coefficients[,1], 3), format='f', digits=3))
  std_error <- formatC(round(mod_summary$coefficients[,2], 3), format='f', digits=3)
  exp_val <- formatC(round(exp(-mod_summary$coefficients[,1]), 3), format='f', digits=3)
  p_val <- formatC(round(pnorm(abs(mod_summary$coefficients[, "t value"]), lower.tail = FALSE) * 2, 3), format='f', digits=3)
  p_val_formatted <- c()
  for(i in 1:length(p_val)) {
    if (p_val[i] < 0.001) {
      p_val_formatted = c(p_val_formatted, "<0.001")
    } else {
      p_val_formatted = c(p_val_formatted, as.character(p_val[i]))
    }
  }
  table <- cbind(coef,exp_val )
  table <- cbind(table,std_error)
  table <- cbind(table, p_val_formatted)
  colnames(table) = c("Coef","Exp(-Coef)","Std. Error", "P-value")
  rownames(table) = var_names_formatted
  # tb <- knitr::kable(table, booktabs=T)
  #https://community.rstudio.com/t/aligning-tables-in-the-center/6699/2
  sig = which(p_val<0.05)
  ret <- table %>%
    kable(booktabs = T, caption=cap) %>%
    kable_styling(latex_options = "hold_position", full_width = F) %>%
    # row_spec(c(2:10), bold = F, color = "black", background = "#E3C5C5") %>%
    # row_spec(c(11:21), bold = F, color = "black", background = "#C5D0E3") %>%
    row_spec(sig[ifelse(sig<=9 & sig>=1, TRUE,FALSE)], background = "#E3C5C5") %>%
    row_spec(sig[ifelse(sig<=22 & sig>=10, TRUE,FALSE)], background = "#C5D0E3")
  return(ret)
}

get_results_table_ordinal(ses_model_summary, c("Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes", "% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space", "Intercept (SES Quartile <= 1)", "Intercept (SES Quartile <= 2)", "Intercept (SES Quartile <= 3)"), "Results: Ordinal Logistic Regression for SES Status")


# els_complete$SESUPPER_2011 = factor(els_complete$SESQU_2011 == 3 | els_complete$SESQU_2011 == 4)
# ses_model = glm(SESUPPER_2011 ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
#                        FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete, family = "binomial")
# ses_model_summary = summary(ses_model)
# get_results_table_logistic(ses_model_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: Logistic Regression for Odds of Being in Upper SES")
```

The student's family's SES status is significantly associated with the odds of being in a lower SES quantile. The odds a student is in an SES quantile lower than 1, 2 or 3, as an adult, decreases by a factor of 0.711 for every one increase in his/her family's SES status composite, all else held constant. On the school side, if the student attended a public school or went to a school where a majority of students received free lunch, the odds of being in a lower SES quantile as an adult increases. Looking at effect sizes, it seems that these home and school financial factors are relatively similar in this model.

In terms of motivation stemming from home or school, the push from teachers is more correlated with the outcome than the push from parents. For every additional year that the parents push their student to achieve in school, the odds of being in a lower SES quantile only decreases by a factor of 0.95, very close to 1, with all else adjusted for. The percentage of sophomores in a college preparation program is also significant; however, the effect size is very minimal as well. Therefore, it seems that the number of years that teachers push a student, a school-related motivational factor, is the most correlated with student SES outcome 9 years after their sophomore year.

Once again, whether a student has access to a computer and internet at home is significantly correlated with the outcome. Students who have this technology access are, on average, 0.77 times less likely to be in the lower SES quantiles. On the other hand, learning hindrance at school due to technology is not significant in the model. In terms of other conditions at school, a student is more likely to be in a lower SES quantile if their learning was hindered by a lack of space, poor building conditions, or poor facilities at school. Therefore, although technology presence is important at home, the lack of resources and good conditions at school also are negatively associated with future success.

Therefore, when predicting the odds of being below a particular SES quantile when the student is an adult, the effect sizes of school factors among these 3 axes are pretty leveled in magnitude when compared with the effect sizes of home factors.

```{r}
# ses_model_lm = lm(log(SES_2011+0.1) ~ SCHOOL_TYPE+SCHOOL_URBAN+DROPOUT_PREV_PGM+VOCATIONAL_PGM  + RACE + FAM_COMP + SES + PT_ED_YEARS + PT_PUSH_YEARS + COMP_HOME + HAS_INTERNET + TEACHER_TECH_ACCESS + LIBRARY_COMPUTER_LAB + PERC_SOPH_COLLEGE_PREP*FREE_LUNCH_CATEGORIES + LOWEST_TEACHER_SALARY_THOUSANDS +LH_POOR_BUILDINGS+LH_POOR_HEATING_AIR_LIGHT+LH_LACK_TEXT+LH_LACK_OF_SPACE+LH_LACK_COMPUTERS+LH_LACK_TECH_FACILITIES+LH_POOR_LIB+LH_POOR_SCIENCE_LAB+LH_POOR_ARTS_FACILITIES , data = els)
# 
# summary(ses_model_lm)
# plot(ses_model_lm)

```

## Education Attainment

### Odds of Dropping Out of High School

```{r}
get_results_table_logistic <- function(mod_summary, var_names_formatted, caption) {
  coef <- (formatC(round(mod_summary$coefficients[,1], 3), format='f', digits=3))
  std_error <- round(mod_summary$coefficients[,2], 3)
  exp_val <- round(exp(mod_summary$coefficients[,1]), 3)
  p_val <- round(mod_summary$coefficients[,4], 3)
  p_val_formatted <- c()
  for(i in 1:length(p_val)) {
    if (p_val[i] < 0.001) {
      p_val_formatted = c(p_val_formatted, "<0.001")
    } else {
      p_val_formatted = c(p_val_formatted, as.character(p_val[i]))
    }
  }
  table <- cbind(coef,exp_val )
  table <- cbind(table,std_error)
  table <- cbind(table, p_val_formatted)
  colnames(table) = c("Coef","Exp(Coef)","Std. Error", "P-value")
  rownames(table) = var_names_formatted
  # tb <- knitr::kable(table, booktabs=T)
  #https://community.rstudio.com/t/aligning-tables-in-the-center/6699/2
  sig = which(p_val<0.05)
  ret <- table %>%
    kable(booktabs = T, caption=caption) %>%
    kable_styling(latex_options = "hold_position", full_width = F) %>%
    # row_spec(c(2:10), bold = F, color = "black", background = "#E3C5C5") %>%
    # row_spec(c(11:21), bold = F, color = "black", background = "#C5D0E3") %>%
    row_spec(sig[ifelse(sig<=10 & sig>=2, TRUE,FALSE)], background = "#E3C5C5") %>%
    row_spec(sig[ifelse(sig<=23 & sig>=11, TRUE,FALSE)], background = "#C5D0E3")
  return(ret)
}

ed_model <- glm(DROPPED_OUT ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete, family="binomial")

ed_model_summary = summary(ed_model)

get_results_table_logistic(ed_model_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes","% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: Logistic Regression for Odds of Dropping Out of HS")

```

In terms of finances at home and at school, it seems that effect sizes are pretty similar between the two groups when modeling the odds of dropping out of high school, with p-values for all variables we investigate for this axis less than the threshold of 0.05. Family SES is significantly negatively associated with the odds, with a coefficient of 0.867, while adjusting for other factors. If the student attends a public school, their odds of dropping out increases by a factor of 1.629, all else held constant. Interestingly, students who attend a school where the majority of students receive free lunch actually have a decreased odds of dropping out by a factor of 0.805, on average. In addition, the lowest teacher salary is significantly negatively correlated with the odds, as the outcome decreases by a factor of 0.98 with every \$1000 increase in the lowest teacher's salary, adjusting for other factors. Therefore, it seems that, when taking all of the factors together and comparing the magnitudes of the effect sizes, school factors are more correlated with the odds of dropping out.

In addition, the external urges from teachers are significantly associated with the outcome, while the urges from the student's parents are not significant. For every additional year a math or English teacher pushes the student to reach in school, the odds of him/her dropping out decreases by a factor of 0.74, all else held constant. Therefore, this axis also shows that school factors are more strongly correlated with the odds of dropping out.

When investigating general conditions at home and at school, it seems that the home factors are the only significant ones using a p-value of 0.05. If a student has two parents, the odds of him/her dropping out of high school decreases by a factor of 0.79 in comparison to a student who lives in a single parent or absent parent home, all else held constant. In addition, access to technology at home and whether or not a student is white are also negatively correlated with the odds of dropping out, when controlling for other factors.

When modeling odds of dropping out of high school, school factors are more strongly associated over home factors when looking at finances and external motivation. However, the opposite is true when looking at environmental conditions.

### Odds of Attaining Bachelor's Degree

```{r}

ed_model_bachelors <- glm(ED_ATNMT_BACHELORS ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE +  MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS  + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete, family = "binomial")

ed_model_bachelors_summary = summary(ed_model_bachelors)

get_results_table_logistic(ed_model_bachelors_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes","% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: Logistic Regression for Odds of Attaining Bachelor's")
```

When looking at wealth factors, a student's family's SES status composite is significantly positively associated with the odds of attaining a Bachelor's degree. For every one increase in SES composite, the odds of the student attaining a Bachelor's degree increases by a factor of 1.6, adjusting for other variables. On the school level, whether or not the high school attended was a public school is significantly negative correlated with the outcome, at a factor of 0.75 when controlling for other factors. Interestingly, the coefficient for the interaction of whether learning was hindered at the student's high schol by a lack of space and whether the school provided a majority of the students with free lunch is significant, while the individual effects are not significant. If a student attended a high school with both of these indicators, the odds of them completing a Bachelor's degree decreases by a factor of 0.75. However, if only one of these indicators is true, the odds is only minimally changed. Therefore, as we found a negative association for only poorer schools that face space limitations, this tangentially supports the findings in previous literatures that showed a larger positive effect when funding poorer schools that also had a lack of space for students. Since SES is a continuous variable, the effect size can be larger than just 1.6 with more than a singular difference in SES from 0. Therefore, it seems that both family and home factors are similar in their effect magnitudes on the odds of attaining a Bachelor's degree, especially when the high school also faced a lack of space and provided a majority of students with free lunch.

When investigating external desires from adult figures, we see that the effect sizes of the variables representing the number of years of education the student's teachers hope for him/her are greater than that for the student's parents. In addition, the number of years of education the parents themselves attained is significantly associated with the outcome. However, the effect size is only a little above 1, so it is very minimal when explaining the odds of attaining a Bachelor's. Therefore, it seems that external motivation from school is more strongly associated with the outcome.

In terms of conditions at home and at school, the coefficient for the student's access to a computer and internet at home is again significant in the model, while that for the variable representing technology access at school is not significant. However, if student learning is hindered by poor building conditions, the odds of completing a Bachelor's degree decreases by a factor of 0.847, all else held constant, with a p-value less than 0.05. In addition, whether or not a student is Asian or White is significantly positively correlated with the outcome as well. It seems that conditions at home and at school are pretty equal in their magnitudes of effect sizes in this model.

In explaining the odds of attaining a Bachelor's degree, it seems that school and home factors have similar magnitudes of effect sizes. However, if the school is on the poorer side, with more than half of students that receive free lunch, and also faces poor conditions, such as a lack of space and poor building conditions, then school factors may overweigh home factors.

## Model Comparisons

On the axis of financial factors, both home and school factors are relatively equal in effect sizes when predicting SES quantile as an adult and the odds of attaining a Bachelor's degree. Test composite is more associated with home factors, while school factors have greater magnitudes of effect sizes for the odds of dropping out.

For external motivation, all four models show that the push from teachers is has a higher effect in magnitude than from the student's parents.

When looking at environmental conditions, both home and school factors are similar in effect size magnitudes for an SES related outcome and odds of attaining a Bachelor's degree. In addition, the home factors are more highly correlated with the test composite score and odds of dropping out.

\newpage

# Appendix

## Standardized Test Composite Score

```{r}
# plot(test_model_both)
# car::vif(test_model_both)
```

```{r, warning=F}
model.lm = test_model_both
model.lm.aug <- augment(model.lm, type.predict = "response")
resid_plot <- model.lm.aug %>%
  ggplot() +
  geom_point(aes(x = .fitted, y = .std.resid)) +
  geom_hline(aes(yintercept = 0), color = "red")+
  labs(x = "Predicted Test Composite",
       y = "Residuals")
```

```{r, fig.cap = "Model Diagnostic Plots: Residual vs. Predicted (Upper Left), QQ Plot (Upper Right), Distribution of Residuals (Lower Left), Vif Values (Lower Right)", warning=F}
qq_plot <- ggplot(model.lm.aug, mapping = aes(sample = .std.resid)) +
  stat_qq() + 
  stat_qq_line() +
  labs(x = "Theoretical",
       y = "Sample")

vif_plot <- ggplot(tidy(rms::vif(model.lm)) %>%
               mutate(var.num = row_number())) +
        geom_point(aes(x = var.num, y = x)) +
        geom_hline(yintercept = 10, color = "red") +
        labs(x = "Variable Number",
             y = "Vif Values")
resid_dist <- ggplot(data = model.lm.aug) +
  geom_histogram(aes(x = .std.resid), binwidth = 0.4) +
  labs(x = "Residuals")

resid_plot+ qq_plot+resid_dist+vif_plot
```

## SES Status

```{r, fig.height=5, fig.width=7}
get_calibration_plot <- function(SES, model) {
  ses.pred <- fitted(ses_model)
  pred_prob <- bind_cols("prob_SES"=ses.pred[,SES], "SES_factor"=els_complete$SESQU_2011 )

  deciles  = quantile(pred_prob$prob_SES, seq(0, 1, length = 11), type=5)
  x_deciles= quantile(pred_prob$prob_SES, seq(0.05, 0.95, length = 10), type=5)
  pred_prob %>%
  mutate(
    bin = case_when(
    prob_SES <= deciles[2] ~ 0.1,
    prob_SES <= deciles[3] ~ 0.2,
    prob_SES <= deciles[4] ~ 0.3,
    prob_SES <= deciles[5] ~ 0.4,
    prob_SES <= deciles[6] ~ 0.5,
    prob_SES <= deciles[7] ~ 0.6,
    prob_SES <= deciles[8] ~ 0.7,
    prob_SES <= deciles[9] ~ 0.8,
    prob_SES <= deciles[10] ~ 0.9,
    prob_SES <= deciles[11] ~ 1)
  ) %>%
  group_by(bin) %>%
  summarise(
    avg_true_prop = mean(SES_factor==SES),
    avg_pred_prob = mean(prob_SES),
    conf_diff =1.96*sqrt(avg_true_prop * (1-avg_true_prop)/n())
  ) %>% ggplot(aes(y=avg_true_prop, x=x_deciles)) +
    geom_line() +
    # geom_bar() +
    geom_errorbar(aes(ymin=avg_true_prop-conf_diff, ymax=avg_true_prop+conf_diff)) +
    geom_abline(aes(intercept=0, slope=1), color="red") +
    theme(legend.position="none")

  # http://www.sthda.com/english/wiki/ggplot2-error-bars-quick-start-guide-r-software-and-data-visualization
}

ses_1_plot <- get_calibration_plot(1)
ses_2_plot <- get_calibration_plot(2)
ses_3_plot <- get_calibration_plot(3)
ses_4_plot <- get_calibration_plot(4)


# white_cal_plot + labs(title="Decile Calibration Plot for Race = White", x="Average Predicted Probability", y="Observed Frequency")
# black_cal_plot + labs(title="Decile Calibration Plot for Race = Black", x="Average Predicted Probability", y="Observed Frequency")
# hisp_cal_plot + labs(title="Decile Calibration Plot for Race = White Hispanic", x="Average Predicted Probability", y="Observed Frequency")
# other_cal_plot + labs(title="Decile Calibration Plot for Race = Other", x="Average Predicted Probability", y="Observed Frequency")
layout(matrix(c(1, 2), nrow=2, ncol=1), heights=c(1,8))

par(mar=rep(0, 4))
plot.new()
text(x=0.5, y=0.5, "Decile Calibration Plots (One vs All)")

grid.arrange(arrangeGrob(
ses_1_plot + labs(title="1st SES Quantile", x="", y="Observed Frequency"),
ses_2_plot + labs(title="2nd SES Quantile", x="", y=""),
ses_3_plot + labs(title="3rd SES Quantile", x="Average Predicted Probability", y="Observed Frequency"),
ses_4_plot + labs(title="4th SES Quantile", x="Average Predicted Probability", y=""),
  ncol=2,
  nrow=2), top=textGrob("Decile Calibration Plots (One vs All)",gp=gpar(fontsize=14,font=3)))

```

```{r, eval=F}
# proportional odds test
mlm <- nnet::multinom(SESQU_2011 ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete)
G <- -2 * (logLik(ses_model)[1] - logLik(mlm)[1])
pchisq(G, df = length(ses_model$zeta) - 1, lower.tail = FALSE)


ses_model_lm = lm(SESQU_2011~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els_complete)

vif(ses_model_lm)

poTest(ses_model)
brant(ses_model)


# model.lm=ses_model
# vif_plot <- ggplot(tidy(vif(model.lm)) %>%
#                mutate(var.num = row_number())) +
#         geom_point(aes(x = var.num, y = x)) +
#         geom_hline(yintercept = 10, color = "red") +
#         labs(x = "Variable Number",
#              y = "Vif Values")

```

Since ordinal logistic regression has a categorical dependent variable, we first fit a linear model with the numeric version of the dependent variable of SES quantile. Then, after performing VIF, we find that there is no multicollinearity, as all of the VIF are under 10.

The proportional odds assumption is violated for 5 variables in the model. However, since we are performing only inference and since the calibration plots are relatively reasonable in comparison to the ideal line, this should not be a large concern.

## Education Attainment

### Odds of Dropping Out of High School

```{r fig.height = 3.5, fig.width = 7}
#http://finzi.psych.upenn.edu/library/broom/html/augment.glm.html
full_model_aug <- broom::augment(ed_model, type.predict = 'response', 
                            type.residuals = 'deviance')
deciles  = quantile(full_model_aug$.fitted, seq(0, 1, length = 11), type=5)
  x_deciles= quantile(full_model_aug$.fitted, seq(0.05, 0.95, length = 10), type=5)
  full_model_aug %>%
    mutate(
    bin = case_when(
    .fitted <= deciles[2] ~ 0.1,
    .fitted <= deciles[3] ~ 0.2,
    .fitted <= deciles[4] ~ 0.3,
    .fitted <= deciles[5] ~ 0.4,
    .fitted <= deciles[6] ~ 0.5,
    .fitted <= deciles[7] ~ 0.6,
    .fitted <= deciles[8] ~ 0.7,
    .fitted <= deciles[9] ~ 0.8,
    .fitted <= deciles[10] ~ 0.9,
    .fitted <= deciles[11] ~ 1)
  ) %>%
  group_by(bin) %>%
  summarise(
    avg_true_prop = mean(as.numeric(DROPPED_OUT)),
    avg_pred_prob = mean(.fitted),
    conf_diff =1.96*sqrt(avg_true_prop * (1-avg_true_prop)/n())
  ) %>% ggplot(aes(y=avg_true_prop, x=x_deciles)) +
    geom_line() +
    # geom_bar() +
    geom_errorbar(aes(ymin=avg_true_prop-conf_diff, ymax=avg_true_prop+conf_diff)) +
    geom_abline(aes(intercept=0, slope=1), color="red") +
    theme(legend.position="none") + labs(title = "Dropping Out of HS - Decile Calibration Plot", x = "Average Predicted Probability", y = "Observed Frequency")

```

The calibration plot shows that the observed frequencies are pretty similar to the average predicted probabilities, with a small blip around an average predicted probability of 0.16. However, the overall trend is very similar to the ideal line.

```{r, eval=F}
vif(ed_model)
```

All VIF of the variables are less than 10, so there are no issues with multicollinearity in our model.

### Odds of Attaining a Bachelor's Degree

```{r fig.height = 3.5, fig.width = 7}
#http://finzi.psych.upenn.edu/library/broom/html/augment.glm.html
full_model_aug <- broom::augment(ed_model_bachelors, type.predict = 'response', 
                            type.residuals = 'deviance')
deciles  = quantile(full_model_aug$.fitted, seq(0, 1, length = 11), type=5)
  x_deciles= quantile(full_model_aug$.fitted, seq(0.05, 0.95, length = 10), type=5)
  full_model_aug %>%
    mutate(
    bin = case_when(
    .fitted <= deciles[2] ~ 0.1,
    .fitted <= deciles[3] ~ 0.2,
    .fitted <= deciles[4] ~ 0.3,
    .fitted <= deciles[5] ~ 0.4,
    .fitted <= deciles[6] ~ 0.5,
    .fitted <= deciles[7] ~ 0.6,
    .fitted <= deciles[8] ~ 0.7,
    .fitted <= deciles[9] ~ 0.8,
    .fitted <= deciles[10] ~ 0.9,
    .fitted <= deciles[11] ~ 1)
  ) %>%
  group_by(bin) %>%
  summarise(
    avg_true_prop = mean(as.numeric(ED_ATNMT_BACHELORS)),
    avg_pred_prob = mean(.fitted),
    conf_diff =1.96*sqrt(avg_true_prop * (1-avg_true_prop)/n())
  ) %>% ggplot(aes(y=avg_true_prop, x=x_deciles)) +
    geom_line() +
    # geom_bar() +
    geom_errorbar(aes(ymin=avg_true_prop-conf_diff, ymax=avg_true_prop+conf_diff)) +
    geom_abline(aes(intercept=0, slope=1), color="red") +
    theme(legend.position="none") + labs(title = "Attaining Bachelor's - Decile Calibration Plot", x = "Average Predicted Probability", y = "Observed Frequency")

```

Although there are some deviances from the ideal line for the predicted probabilities greater than around 0.5, the line observed frequencies are still relatively close to the average predicted probabilities.

```{r, eval=F}
vif(ed_model_bachelors)
```

All VIF of the variables are less than 10, so there are no issues with multicollinearity in our model.

## Sensitivity Analysis Without Imputed Data

```{r}
test_model_both = lm(TEST_COMP ~  RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS+ PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els)
test_model_summary = summary(test_model_both)

get_results_table(test_model_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes", "% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: OLS Model for Test Composite Score")

```

```{r}
# https://stats.idre.ucla.edu/r/dae/ordinal-logistic-regression/
ses_model = polr(factor(SESQU_2011) ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els, Hess = TRUE)
ses_model_summary = summary(ses_model)
# ctable <- coef(ses_model_summary)
# p <- pnorm(abs(ctable[, "t value"]), lower.tail = FALSE) * 2
# is_sig <- p <= 0.05
# (ctable <- cbind(ctable, "exp(coef)" = exp(ctable[,"Value"]), "p value" = p, "sig"=is_sig))

get_results_table_ordinal(ses_model_summary, c("Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes", "% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space", "Intercept (SES Quartile <= 1)", "Intercept (SES Quartile <= 2)", "Intercept (SES Quartile <= 3)"), "Results: Ordinal Logistic Regression for SES Status")
```


```{r}
ed_model <- glm(DROPPED_OUT ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE + MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els, family="binomial")

ed_model_summary = summary(ed_model)

get_results_table_logistic(ed_model_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes","% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: Logistic Regression for Odds of Dropping Out of HS")

```


```{r}

ed_model_bachelors <- glm(ED_ATNMT_BACHELORS ~ RACE + FAM_COMP + SES + PT_ED_YEARS  + PT_PUSH_YEARS  + COMP_AND_INTERNET + SCHOOL_TYPE +  MATH_PUSH_YEARS + ENGLISH_PUSH_YEARS  + PERC_SOPH_COLLEGE_PREP + LOWEST_TEACHER_SALARY_THOUSANDS +
                       FREE_LUNCH_MAJ*LH_LACK_OF_SPACE + LH_POOR_BUILDINGS+ LH_POOR_HEATING_AIR_LIGHT + LH_LACK_TEXT + LH_POOR_FACILITIES + LH_POOR_TECH, data = els, family = "binomial")

ed_model_bachelors_summary = summary(ed_model_bachelors)

get_results_table_logistic(ed_model_bachelors_summary, c("Intercept", "Race=API", "Race=Black", "Race=Hispanic", "Race=White", "Has Two Parents", "SES", "# Years Parents Education", "# Years Education Parents Push", "Has Computer and Internet", "Is Public School", "# Years Education Math Teacher Pushes", "# Years Education English Teacher Pushes","% Sophomores in College Prep", "Lowest Teacher Salary (thousands)", "Majority Students Have Free Lunch","LH by Lack of Space", "LH by Poor Building Conditions", "LH by Poor Heating/Air/Light", "LH by Lack of Text/Supplies", "LH by Poor Facilities", "LH by Poor Technology", "Majority Free Lunch:LH by Lack of Space"), "Results: Logistic Regression for Odds of Attaining Bachelor's")
```


